/* Step 1 - enable clr on the database - run reconfigure to install */
exec sp_changedbowner 'sa';

ALTER DATABASE example2 SET trustworthy ON
go
RECONFIGURE;
GO

/* Step 2 - enable clr on the database - run reconfigure to install */
sp_configure 'clr enabled', 1  
GO  
RECONFIGURE  
GO

sp_configure 'show advanced options', 0;

/* Step 3 - intall the object in sql 
For this demo we are using this assembly
C:\Users\sdeggans\source\repos\UpperCaseFunction\bin\Release\netstandard2.0\UpperCaseFunction.dll
The fully qualified object name for this is [UpperCaseFunction.UpperCaseFunc]
It accepts a string and returns a string. The return string should be upper case.
*/
CREATE ASSEMBLY [UpperCaseFunction] FROM 
'C:\assembly\UpperCaseFunction.dll' 
WITH PERMISSION_SET = UNSAFE;

/* Step 4 - Next we want to test out the assembly to make sure we can use it*/
GO
CREATE FUNCTION dbo.UpperCaseFunction(@targetText nvarchar(200)) returns nvarchar(200)
AS EXTERNAL NAME
UpperCaseFunction.[UpperCaseFunction.UpperCaseFunc].MakeUpperCase
GO

/* Step 5 - test our code */
USE [example2]
GO
/*Test out our new assembly to make sure it's working */
SELECT [dbo].[UpperCaseFunction] ('this is a test to see if it gets upper case')

/* Step 6 - Prepare to add to a production / SQL Managed Instance
 - Right click on the function and select Script Assembly as Create To...
 - Copy the resulting query
 */

USE [example3]
GO

/****** Object:  SqlAssembly [UpperCaseFunction]    Script Date: 10/5/2020 1:15:40 PM ******/
CREATE ASSEMBLY [UpperCaseFunction]
FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C0103000CD456AD0000000000000000E00022200B01300000080000000600000000000016270000002000000040000000000010002000000002000004000000000000000600000000000000008000000002000000000000030060850000100000100000000010000010000000000000100000000000000000000000C32600004F00000000400000B803000000000000000000000000000000000000006000000C00000020260000380000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E746578740000001C070000002000000008000000020000000000000000000000000000200000602E72737263000000B80300000040000000040000000A0000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000000E00000000000000000000000000004000004200000000000000000000000000000000F726000000000000480000000200050058200000C805000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001E026F0F00000A2A42534A4201000100000000000C00000076342E302E33303331390000000005006C000000B8010000237E0000240200007802000023537472696E6773000000009C0400000400000023555300A0040000100000002347554944000000B00400001801000023426C6F620000000000000002000001471500000900000000FA01330016000001000000110000000200000001000000010000000F0000000E00000001000000010000000000B50101000000000006000901360206007601360206003D0004020F005602000006006500D2010600EC00D2010600CD00D20106005D01D20106002901D20106004201D20106007C00D20106005100170206002F0017020600B000D20106009700940106006502CB010600AE01CB010000000001000000000001000100810110001300E4014100010001005020000000009600210027000100000001006C020900FE0101001100FE0106001900FE010A002900FE0110003100FE0110003900FE0110004100FE0110004900FE0110005100FE0110005900FE0110006100FE0115006900FE0110007100FE0110007900FE0110008900F6011A002E000B002C002E00130035002E001B0054002E0023005D002E002B0074002E00330074002E003B0074002E0043005D002E004B007A002E00530074002E005B0074002E00630092002E006B00BC002E007300C900048000000100000000000000000000000000E40100000400000000000000000000001E000A000000000000000000003C4D6F64756C653E006D73636F726C69620055707065724361736546756E63004D616B6555707065724361736500477569644174747269627574650044656275676761626C6541747472696275746500436F6D56697369626C6541747472696275746500417373656D626C795469746C6541747472696275746500417373656D626C7954726164656D61726B417474726962757465005461726765744672616D65776F726B41747472696275746500417373656D626C7946696C6556657273696F6E41747472696275746500417373656D626C79436F6E66696775726174696F6E41747472696275746500417373656D626C794465736372697074696F6E41747472696275746500436F6D70696C6174696F6E52656C61786174696F6E7341747472696275746500417373656D626C7950726F6475637441747472696275746500417373656D626C79436F7079726967687441747472696275746500417373656D626C79436F6D70616E794174747269627574650052756E74696D65436F6D7061746962696C6974794174747269627574650053797374656D2E52756E74696D652E56657273696F6E696E6700537472696E670055707065724361736546756E6374696F6E2E646C6C0053797374656D0053797374656D2E5265666C656374696F6E0055707065724361736546756E6374696F6E00546F5570706572002E63746F720053797374656D2E446961676E6F73746963730053797374656D2E52756E74696D652E496E7465726F7053657276696365730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300446562756767696E674D6F646573004F626A6563740054617267657454657874000000000000CAD40D1998D8234EA1BF0775C65F072100042001010803200001052001011111042001010E04200101020320000E08B77A5C561934E0890400010E0E0801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F7773010801000200000000001601001155707065724361736546756E6374696F6E000005010000000017010012436F7079726967687420C2A920203230323000002901002439343836393938352D636662632D343331662D383961302D64616164323036313438333900000C010007312E302E302E3000004D01001C2E4E45544672616D65776F726B2C56657273696F6E3D76342E372E320100540E144672616D65776F726B446973706C61794E616D65142E4E4554204672616D65776F726B20342E372E320000000000D1DB60BE00000000020000006B00000058260000580800000000000000000000000000001000000000000000000000000000000052534453E3CCB37F2A1CDD4B96733F430692197D01000000433A5C55736572735C7364656767616E735C736F757263655C7265706F735C55707065724361736546756E6374696F6E5C6F626A5C52656C656173655C55707065724361736546756E6374696F6E2E70646200EB260000000000000000000005270000002000000000000000000000000000000000000000000000F7260000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C000000000000FF2500200010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001001000000018000080000000000000000000000000000001000100000030000080000000000000000000000000000001000000000048000000584000005C03000000000000000000005C0334000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000001000000000000000100000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004BC020000010053007400720069006E006700460069006C00650049006E0066006F0000009802000001003000300030003000300034006200300000001A000100010043006F006D006D0065006E007400730000000000000022000100010043006F006D00700061006E0079004E0061006D00650000000000000000004C0012000100460069006C0065004400650073006300720069007000740069006F006E0000000000550070007000650072004300610073006500460075006E006300740069006F006E000000300008000100460069006C006500560065007200730069006F006E000000000031002E0030002E0030002E00300000004C001600010049006E007400650072006E0061006C004E0061006D0065000000550070007000650072004300610073006500460075006E006300740069006F006E002E0064006C006C0000004800120001004C006500670061006C0043006F007000790072006900670068007400000043006F0070007900720069006700680074002000A90020002000320030003200300000002A00010001004C006500670061006C00540072006100640065006D00610072006B00730000000000000000005400160001004F0072006900670069006E0061006C00460069006C0065006E0061006D0065000000550070007000650072004300610073006500460075006E006300740069006F006E002E0064006C006C000000440012000100500072006F0064007500630074004E0061006D00650000000000550070007000650072004300610073006500460075006E006300740069006F006E000000340008000100500072006F006400750063007400560065007200730069006F006E00000031002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000031002E0030002E0030002E003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000C000000183700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
WITH PERMISSION_SET = UNSAFE
GO

/* Step 7 - running the above might result in an error because the object isn't trusted.
CREATE ASSEMBLY for assembly 'UpperCaseFunction' failed because assembly 'UpperCaseFunction' is not trusted. 
The assembly is trusted when either of the following is true: the assembly is signed with a 
certificate or an asymmetric key that has a corresponding login with UNSAFE ASSEMBLY permission, 
or the assembly is trusted using sp_add_trusted_assembly.

to make it trusted, do the following:
*/

DECLARE @clrDescription nvarchar(4000) = N'split, version=0.0.0.0, culture=neutral, publickeytoken=null, processorarchitecture=msil';
DECLARE @clrBin varbinary(max) = 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C0103000CD456AD0000000000000000E00022200B01300000080000000600000000000016270000002000000040000000000010002000000002000004000000000000000600000000000000008000000002000000000000030060850000100000100000000010000010000000000000100000000000000000000000C32600004F00000000400000B803000000000000000000000000000000000000006000000C00000020260000380000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E746578740000001C070000002000000008000000020000000000000000000000000000200000602E72737263000000B80300000040000000040000000A0000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000000E00000000000000000000000000004000004200000000000000000000000000000000F726000000000000480000000200050058200000C805000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001E026F0F00000A2A42534A4201000100000000000C00000076342E302E33303331390000000005006C000000B8010000237E0000240200007802000023537472696E6773000000009C0400000400000023555300A0040000100000002347554944000000B00400001801000023426C6F620000000000000002000001471500000900000000FA01330016000001000000110000000200000001000000010000000F0000000E00000001000000010000000000B50101000000000006000901360206007601360206003D0004020F005602000006006500D2010600EC00D2010600CD00D20106005D01D20106002901D20106004201D20106007C00D20106005100170206002F0017020600B000D20106009700940106006502CB010600AE01CB010000000001000000000001000100810110001300E4014100010001005020000000009600210027000100000001006C020900FE0101001100FE0106001900FE010A002900FE0110003100FE0110003900FE0110004100FE0110004900FE0110005100FE0110005900FE0110006100FE0115006900FE0110007100FE0110007900FE0110008900F6011A002E000B002C002E00130035002E001B0054002E0023005D002E002B0074002E00330074002E003B0074002E0043005D002E004B007A002E00530074002E005B0074002E00630092002E006B00BC002E007300C900048000000100000000000000000000000000E40100000400000000000000000000001E000A000000000000000000003C4D6F64756C653E006D73636F726C69620055707065724361736546756E63004D616B6555707065724361736500477569644174747269627574650044656275676761626C6541747472696275746500436F6D56697369626C6541747472696275746500417373656D626C795469746C6541747472696275746500417373656D626C7954726164656D61726B417474726962757465005461726765744672616D65776F726B41747472696275746500417373656D626C7946696C6556657273696F6E41747472696275746500417373656D626C79436F6E66696775726174696F6E41747472696275746500417373656D626C794465736372697074696F6E41747472696275746500436F6D70696C6174696F6E52656C61786174696F6E7341747472696275746500417373656D626C7950726F6475637441747472696275746500417373656D626C79436F7079726967687441747472696275746500417373656D626C79436F6D70616E794174747269627574650052756E74696D65436F6D7061746962696C6974794174747269627574650053797374656D2E52756E74696D652E56657273696F6E696E6700537472696E670055707065724361736546756E6374696F6E2E646C6C0053797374656D0053797374656D2E5265666C656374696F6E0055707065724361736546756E6374696F6E00546F5570706572002E63746F720053797374656D2E446961676E6F73746963730053797374656D2E52756E74696D652E496E7465726F7053657276696365730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300446562756767696E674D6F646573004F626A6563740054617267657454657874000000000000CAD40D1998D8234EA1BF0775C65F072100042001010803200001052001011111042001010E04200101020320000E08B77A5C561934E0890400010E0E0801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F7773010801000200000000001601001155707065724361736546756E6374696F6E000005010000000017010012436F7079726967687420C2A920203230323000002901002439343836393938352D636662632D343331662D383961302D64616164323036313438333900000C010007312E302E302E3000004D01001C2E4E45544672616D65776F726B2C56657273696F6E3D76342E372E320100540E144672616D65776F726B446973706C61794E616D65142E4E4554204672616D65776F726B20342E372E320000000000D1DB60BE00000000020000006B00000058260000580800000000000000000000000000001000000000000000000000000000000052534453E3CCB37F2A1CDD4B96733F430692197D01000000433A5C55736572735C7364656767616E735C736F757263655C7265706F735C55707065724361736546756E6374696F6E5C6F626A5C52656C656173655C55707065724361736546756E6374696F6E2E70646200EB260000000000000000000005270000002000000000000000000000000000000000000000000000F7260000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C000000000000FF2500200010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001001000000018000080000000000000000000000000000001000100000030000080000000000000000000000000000001000000000048000000584000005C03000000000000000000005C0334000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000001000000000000000100000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004BC020000010053007400720069006E006700460069006C00650049006E0066006F0000009802000001003000300030003000300034006200300000001A000100010043006F006D006D0065006E007400730000000000000022000100010043006F006D00700061006E0079004E0061006D00650000000000000000004C0012000100460069006C0065004400650073006300720069007000740069006F006E0000000000550070007000650072004300610073006500460075006E006300740069006F006E000000300008000100460069006C006500560065007200730069006F006E000000000031002E0030002E0030002E00300000004C001600010049006E007400650072006E0061006C004E0061006D0065000000550070007000650072004300610073006500460075006E006300740069006F006E002E0064006C006C0000004800120001004C006500670061006C0043006F007000790072006900670068007400000043006F0070007900720069006700680074002000A90020002000320030003200300000002A00010001004C006500670061006C00540072006100640065006D00610072006B00730000000000000000005400160001004F0072006900670069006E0061006C00460069006C0065006E0061006D0065000000550070007000650072004300610073006500460075006E006300740069006F006E002E0064006C006C000000440012000100500072006F0064007500630074004E0061006D00650000000000550070007000650072004300610073006500460075006E006300740069006F006E000000340008000100500072006F006400750063007400560065007200730069006F006E00000031002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000031002E0030002E0030002E003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000C000000183700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000;
DECLARE @hash varbinary(64);
SET @hash = HASHBYTES('SHA2_512', @clrBin);
SELECT @hash;

EXECUTE sys.sp_add_trusted_assembly @hash, @clrDescription

SELECT * FROM sys.trusted_assemblies;

/* Step 8 - once the assembly is trusted, rerun step 7 */


/* End credits: Thanks to Wayne Sheffield for this blog post
https://blog.waynesheffield.com/wayne/archive/2019/01/clr-strict-security-sql-2017/
*/
